{"version":3,"file":"signal.js","sources":["../src/signal.ts"],"sourcesContent":["/**\n * Signal Module\n *\n * @packageDocumentation\n * @document ./signal.offer.guide.md\n * @document ./signal.answer.guide.md\n */\nimport { io, ManagerOptions, Socket, SocketOptions } from 'socket.io-client';\nimport QRCodeStyling from 'qr-code-styling';\nimport { Options as QRCodeOptions } from 'qr-code-styling';\nconst QRCodeStylingConstructor = (QRCodeStyling as any).default || QRCodeStyling;\nimport { EventEmitter } from 'eventemitter3';\nimport { v7 as uuidv7 } from 'uuid';\n\nimport { attestation } from './attestation.js';\nimport { assertion } from './assertion.js';\n\nimport { DEFAULT_QR_CODE_OPTIONS } from './constants.js';\nimport {\n  ORIGIN_IS_MISSING_MESSAGE,\n  REQUEST_IN_PROCESS_MESSAGE,\n  REQUEST_IS_MISSING_MESSAGE,\n  UNAUTHENTICATED_MESSAGE,\n} from './errors.js';\nimport { DEFAULT_ATTESTATION_OPTIONS } from './attestation.fetch.js';\n\nexport type LinkMessage = {\n  credId?: string;\n  requestId: string;\n  wallet: string;\n};\n\nexport async function generateQRCode(\n  { requestId, url }: { requestId?: string; url: string },\n  qrCodeOptions: QRCodeOptions = DEFAULT_QR_CODE_OPTIONS,\n) {\n  if (typeof requestId === 'undefined')\n    throw new Error(REQUEST_IS_MISSING_MESSAGE);\n  qrCodeOptions.data = generateDeepLink(url, requestId);\n\n  const qrCode = new QRCodeStylingConstructor(qrCodeOptions);\n  return await qrCode.getRawData('png').then((blob) => {\n    if (!blob) throw new TypeError('Could not get qrcode blob');\n    return URL.createObjectURL(blob);\n  });\n}\n\n/**\n * Generate a Deep Link URI\n * @param {string} origin\n * @param requestId\n */\nexport function generateDeepLink(origin: string, requestId: string) {\n  if (typeof origin !== 'string') {\n    throw new Error(ORIGIN_IS_MISSING_MESSAGE);\n  }\n  if (typeof requestId !== 'string') {\n    throw new Error(REQUEST_IS_MISSING_MESSAGE);\n  }\n  return `liquid://${origin.replace('https://', '')}/?requestId=${requestId}`;\n}\n/**\n *\n */\nexport class SignalClient extends EventEmitter {\n  url: string;\n  type: 'offer' | 'answer' | null = null;\n  private authenticated: boolean = false;\n  private requestId: string | undefined;\n  peerClient: RTCPeerConnection | undefined;\n  private qrCodeOptions: QRCodeOptions = DEFAULT_QR_CODE_OPTIONS;\n  socket: Socket;\n\n  /**\n   *\n   * @param url\n   * @param options\n   */\n  constructor(\n    url: string,\n    options: Partial<ManagerOptions & SocketOptions> = { autoConnect: true },\n  ) {\n    super();\n    this.url = url;\n    this.socket = io(url, options);\n\n    this.socket.on('connect', () => {\n      this.emit('connect', this.socket.id);\n    });\n\n    this.socket.on('disconnect', () => {\n      this.emit('disconnect', this.socket.id);\n    });\n  }\n\n  static generateRequestId(): string {\n    return uuidv7();\n  }\n\n  /**\n   * Handles the process of attestation by invoking the provided challenge handler and the specified options.\n   *\n   * @param {function(Uint8Array): any} onChallenge - A callback function to handle the challenge. Receives a Uint8Array representing the challenge.\n   * @param {object} [options=DEFAULT_ATTESTATION_OPTIONS] - Configuration options for the attestation process.\n   * @param debug\n   * @return {Promise<void>} A promise that resolves when attestation is successfully completed or rejects with an error if it fails.\n   */\n  async attestation(\n    onChallenge: (challenge: Uint8Array) => any,\n    options = DEFAULT_ATTESTATION_OPTIONS,\n    debug = false,\n  ) {\n    try {\n      const response = await attestation({\n        origin: this.url,\n        onChallenge,\n        options,\n        debug,\n      });\n      this.authenticated = true;\n      return response;\n    } catch (e) {\n      this.authenticated = false;\n      throw e;\n    }\n  }\n  async assertion(credId: string, debug = false) {\n    try {\n      const response = await assertion({\n        origin: this.url,\n        credId,\n        debug,\n      });\n      this.authenticated = true;\n      return response;\n    } catch (e) {\n      this.authenticated = false;\n      throw e;\n    }\n  }\n  /**\n   * Create QR Code\n   */\n  async qrCode() {\n    if (typeof this.requestId === 'undefined')\n      throw new Error(REQUEST_IS_MISSING_MESSAGE);\n    return generateQRCode(\n      { requestId: this.requestId, url: this.url },\n      this.qrCodeOptions,\n    );\n  }\n\n  /**\n   * Create a Deep Link URI\n   * @param requestId\n   */\n  deepLink(requestId: string) {\n    if (\n      typeof requestId !== 'string' &&\n      typeof this.requestId === 'undefined'\n    ) {\n      throw new Error(REQUEST_IS_MISSING_MESSAGE);\n    }\n    return generateDeepLink(this.url, requestId || this.requestId || '');\n  }\n  /**\n   * # Create a peer connection\n   *\n   * Send the nonce to the server and listen to a specified type.\n   *\n   * ## Offer\n   *   - Will wait for an offer-description from the server\n   *   - Will send an answer-description to the server\n   *   - Will send candidates to the server\n   *\n   * ## Answer\n   *  - Will send an offer-description to the server\n   *  - Will wait for an answer-description from the server\n   *  - Will send candidates to the server\n   *\n   * @param requestId\n   * @param type\n   * @param config\n   */\n  async peer(\n    requestId: string | undefined,\n    type: 'offer' | 'answer',\n    config: RTCConfiguration = {\n      iceServers: [\n        {\n          urls: [\n            'stun:stun.l.google.com:19302',\n            'stun:stun1.l.google.com:19302',\n            'stun:stun2.l.google.com:19302',\n          ],\n        },\n      ],\n      iceCandidatePoolSize: 10,\n    },\n  ): Promise<RTCDataChannel> {\n    if (typeof this.requestId !== 'undefined')\n      throw new Error(REQUEST_IN_PROCESS_MESSAGE);\n\n    return new Promise(async (resolve) => {\n      if (typeof requestId === 'undefined') {\n        throw new Error(REQUEST_IS_MISSING_MESSAGE);\n      }\n      let candidatesBuffer: RTCIceCandidateInit[] = [];\n      // Create Peer Connection\n      this.peerClient = new RTCPeerConnection(config);\n\n      this.type = type === 'offer' ? 'answer' : 'offer';\n      // Wait for a link message\n      type === 'offer' && (await this.link(requestId));\n      // Listen for Local Candidates\n      this.peerClient.onicecandidate = (event) => {\n        if (event.candidate) {\n          this.emit(`${this.type}-candidate`, event.candidate.toJSON());\n          this.socket.emit(`${this.type}-candidate`, event.candidate.toJSON());\n        }\n      };\n      // Listen to Remote Candidates\n      this.socket.on(\n        `${type}-candidate`,\n        async (candidate: RTCIceCandidateInit) => {\n          if (\n            this.peerClient?.remoteDescription &&\n            this.peerClient?.remoteDescription\n          ) {\n            this.emit(`${type}-candidate`, candidate);\n            await this.peerClient.addIceCandidate(\n              new RTCIceCandidate(candidate),\n            );\n          } else {\n            candidatesBuffer.push(candidate);\n          }\n        },\n      );\n\n      // Listen for Remote DataChannel and Resolve\n      this.peerClient.ondatachannel = (event) => {\n        this.emit('data-channel', event.channel);\n        resolve(event.channel);\n      };\n      // Handle Session Descriptions\n      if (type === 'offer') {\n        const sdp = await this.signal(type);\n        await this.peerClient.setRemoteDescription(sdp);\n        const answer = await this.peerClient.createAnswer();\n        await this.peerClient.setLocalDescription(answer);\n        if (candidatesBuffer.length > 0) {\n          await Promise.all(\n            candidatesBuffer.map(async (candidate) => {\n              this.emit(`${type}-candidate`, candidate);\n              await this.peerClient?.addIceCandidate(\n                new RTCIceCandidate(candidate),\n              );\n            }),\n          );\n          candidatesBuffer = [];\n        }\n        this.emit(`${this.type}-description`, answer.sdp);\n        this.socket.emit(`${this.type}-description`, answer.sdp);\n      } else {\n        const dataChannel = this.peerClient.createDataChannel('liquid');\n        const localSdp = await this.peerClient.createOffer();\n        await this.peerClient.setLocalDescription(localSdp);\n        this.socket.emit(`${this.type}-description`, localSdp.sdp);\n        this.emit(`${this.type}-description`, localSdp.sdp);\n        const sdp = await this.signal(type);\n        await this.peerClient.setRemoteDescription(sdp);\n        if (candidatesBuffer.length > 0) {\n          await Promise.all(\n            candidatesBuffer.map(async (candidate) => {\n              this.emit(`${type}-candidate`, candidate);\n              await this.peerClient?.addIceCandidate(\n                new RTCIceCandidate(candidate),\n              );\n            }),\n          );\n          candidatesBuffer = [];\n        }\n        this.emit('data-channel', dataChannel);\n        resolve(dataChannel);\n      }\n    });\n  }\n\n  /**\n   * Await for a link message for a given requestId\n   * @param requestId\n   */\n  async link(requestId: string) {\n    if (typeof this.requestId !== 'undefined')\n      throw new Error(REQUEST_IN_PROCESS_MESSAGE);\n    this.requestId = requestId;\n    this.emit('link', { requestId });\n\n    return new Promise<LinkMessage>((resolve) => {\n      this.socket.emit(\n        'link',\n        { requestId },\n        ({ data }: { data: LinkMessage }) => {\n          this.authenticated = true;\n          delete this.requestId;\n\n          this.emit('link-message', data);\n          resolve(data);\n        },\n      );\n    });\n  }\n\n  /**\n   *\n   * @param type\n   */\n  async signal(type: 'offer' | 'answer') {\n    if (!this.authenticated) throw new Error(UNAUTHENTICATED_MESSAGE);\n    this.emit('signal', { type });\n    return new Promise<RTCSessionDescriptionInit>((resolve) => {\n      this.socket.once(`${type}-description`, (sdp: string) => {\n        const description = { type, sdp } as RTCSessionDescriptionInit;\n        this.emit(`${type}-description`, description);\n        resolve(description);\n      });\n    });\n  }\n\n  close(disconnect = false) {\n    this.socket.removeAllListeners();\n    delete this.requestId;\n    this.authenticated = false;\n    if (disconnect) this.socket.disconnect();\n    this.emit('close');\n  }\n}\n"],"names":["uuidv7"],"mappings":"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"}