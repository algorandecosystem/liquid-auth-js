{"version":3,"file":"signal.js","sources":["../src/signal.ts"],"sourcesContent":["/**\n * Signal Module\n *\n * @packageDocumentation\n * @document ./signal.offer.guide.md\n * @document ./signal.answer.guide.md\n */\nimport { io, ManagerOptions, Socket, SocketOptions } from 'socket.io-client';\nimport QRCode from 'qrcode';\nimport type { QRCodeToDataURLOptions } from 'qrcode';\nimport { EventEmitter } from 'eventemitter3';\nimport { v7 as uuidv7 } from 'uuid';\n\nimport { attestation } from './attestation.js';\nimport { assertion } from './assertion.js';\n\nimport { DEFAULT_QR_CODE_OPTIONS } from './constants.js';\nimport {\n  ORIGIN_IS_MISSING_MESSAGE,\n  REQUEST_IN_PROCESS_MESSAGE,\n  REQUEST_IS_MISSING_MESSAGE,\n  UNAUTHENTICATED_MESSAGE,\n} from './errors.js';\nimport { DEFAULT_ATTESTATION_OPTIONS } from './attestation.fetch.js';\n\nexport type LinkMessage = {\n  credId?: string;\n  requestId: string;\n  wallet: string;\n};\n\nexport async function generateQRCode(\n  { requestId, url }: { requestId?: string; url: string },\n  qrCodeOptions: QRCodeToDataURLOptions = DEFAULT_QR_CODE_OPTIONS,\n) {\n  if (typeof requestId === 'undefined')\n    throw new Error(REQUEST_IS_MISSING_MESSAGE);\n  const data = generateDeepLink(url, requestId);\n  return await QRCode.toDataURL(data, qrCodeOptions);\n}\n\n/**\n * Generate a Deep Link URI\n * @param {string} origin\n * @param requestId\n */\nexport function generateDeepLink(origin: string, requestId: string) {\n  if (typeof origin !== 'string') {\n    throw new Error(ORIGIN_IS_MISSING_MESSAGE);\n  }\n  if (typeof requestId !== 'string') {\n    throw new Error(REQUEST_IS_MISSING_MESSAGE);\n  }\n  return `liquid://${origin.replace('https://', '')}/?requestId=${requestId}`;\n}\n/**\n *\n */\nexport class SignalClient extends EventEmitter {\n  url: string;\n  type: 'offer' | 'answer' | null = null;\n  private authenticated: boolean = false;\n  private requestId: string | undefined;\n  peerClient: RTCPeerConnection | undefined;\n  private qrCodeOptions: QRCodeToDataURLOptions = DEFAULT_QR_CODE_OPTIONS;\n  socket: Socket;\n\n  /**\n   *\n   * @param url\n   * @param options\n   */\n  constructor(\n    url: string,\n    options: Partial<ManagerOptions & SocketOptions> = { autoConnect: true },\n  ) {\n    super();\n    this.url = url;\n    this.socket = io(url, options);\n\n    this.socket.on('connect', () => {\n      this.emit('connect', this.socket.id);\n    });\n\n    this.socket.on('disconnect', () => {\n      this.emit('disconnect', this.socket.id);\n    });\n  }\n\n  static generateRequestId(): string {\n    return uuidv7();\n  }\n\n  /**\n   * Handles the process of attestation by invoking the provided challenge handler and the specified options.\n   *\n   * @param {function(Uint8Array): any} onChallenge - A callback function to handle the challenge. Receives a Uint8Array representing the challenge.\n   * @param {object} [options=DEFAULT_ATTESTATION_OPTIONS] - Configuration options for the attestation process.\n   * @param debug\n   * @return {Promise<void>} A promise that resolves when attestation is successfully completed or rejects with an error if it fails.\n   */\n  async attestation(\n    onChallenge: (challenge: Uint8Array) => any,\n    options = DEFAULT_ATTESTATION_OPTIONS,\n    debug = false,\n  ) {\n    try {\n      const response = await attestation({\n        origin: this.url,\n        onChallenge,\n        options,\n        debug,\n      });\n      this.authenticated = true;\n      return response;\n    } catch (e) {\n      this.authenticated = false;\n      throw e;\n    }\n  }\n  async assertion(credId: string, debug = false) {\n    try {\n      const response = await assertion({\n        origin: this.url,\n        credId,\n        debug,\n      });\n      this.authenticated = true;\n      return response;\n    } catch (e) {\n      this.authenticated = false;\n      throw e;\n    }\n  }\n  /**\n   * Create QR Code\n   */\n  async qrCode() {\n    if (typeof this.requestId === 'undefined')\n      throw new Error(REQUEST_IS_MISSING_MESSAGE);\n    return generateQRCode(\n      { requestId: this.requestId, url: this.url },\n      this.qrCodeOptions,\n    );\n  }\n\n  /**\n   * Create a Deep Link URI\n   * @param requestId\n   */\n  deepLink(requestId: string) {\n    if (\n      typeof requestId !== 'string' &&\n      typeof this.requestId === 'undefined'\n    ) {\n      throw new Error(REQUEST_IS_MISSING_MESSAGE);\n    }\n    return generateDeepLink(this.url, requestId || this.requestId || '');\n  }\n  /**\n   * # Create a peer connection\n   *\n   * Send the nonce to the server and listen to a specified type.\n   *\n   * ## Offer\n   *   - Will wait for an offer-description from the server\n   *   - Will send an answer-description to the server\n   *   - Will send candidates to the server\n   *\n   * ## Answer\n   *  - Will send an offer-description to the server\n   *  - Will wait for an answer-description from the server\n   *  - Will send candidates to the server\n   *\n   * @param requestId\n   * @param type\n   * @param config\n   */\n  async peer(\n    requestId: string | undefined,\n    type: 'offer' | 'answer',\n    config: RTCConfiguration = {\n      iceServers: [\n        {\n          urls: [\n            'stun:stun.l.google.com:19302',\n            'stun:stun1.l.google.com:19302',\n            'stun:stun2.l.google.com:19302',\n          ],\n        },\n      ],\n      iceCandidatePoolSize: 10,\n    },\n  ): Promise<RTCDataChannel> {\n    if (typeof this.requestId !== 'undefined')\n      throw new Error(REQUEST_IN_PROCESS_MESSAGE);\n\n    return new Promise(async (resolve) => {\n      if (typeof requestId === 'undefined') {\n        throw new Error(REQUEST_IS_MISSING_MESSAGE);\n      }\n      let candidatesBuffer: RTCIceCandidateInit[] = [];\n      // Create Peer Connection\n      this.peerClient = new RTCPeerConnection(config);\n\n      this.type = type === 'offer' ? 'answer' : 'offer';\n      // Wait for a link message\n      type === 'offer' && (await this.link(requestId));\n      // Listen for Local Candidates\n      this.peerClient.onicecandidate = (event) => {\n        if (event.candidate) {\n          this.emit(`${this.type}-candidate`, event.candidate.toJSON());\n          this.socket.emit(`${this.type}-candidate`, event.candidate.toJSON());\n        }\n      };\n      // Listen to Remote Candidates\n      this.socket.on(\n        `${type}-candidate`,\n        async (candidate: RTCIceCandidateInit) => {\n          if (\n            this.peerClient?.remoteDescription &&\n            this.peerClient?.remoteDescription\n          ) {\n            this.emit(`${type}-candidate`, candidate);\n            await this.peerClient.addIceCandidate(\n              new RTCIceCandidate(candidate),\n            );\n          } else {\n            candidatesBuffer.push(candidate);\n          }\n        },\n      );\n\n      // Listen for Remote DataChannel and Resolve\n      this.peerClient.ondatachannel = (event) => {\n        this.emit('data-channel', event.channel);\n        resolve(event.channel);\n      };\n      // Handle Session Descriptions\n      if (type === 'offer') {\n        const sdp = await this.signal(type);\n        await this.peerClient.setRemoteDescription(sdp);\n        const answer = await this.peerClient.createAnswer();\n        await this.peerClient.setLocalDescription(answer);\n        if (candidatesBuffer.length > 0) {\n          await Promise.all(\n            candidatesBuffer.map(async (candidate) => {\n              this.emit(`${type}-candidate`, candidate);\n              await this.peerClient?.addIceCandidate(\n                new RTCIceCandidate(candidate),\n              );\n            }),\n          );\n          candidatesBuffer = [];\n        }\n        this.emit(`${this.type}-description`, answer.sdp);\n        this.socket.emit(`${this.type}-description`, answer.sdp);\n      } else {\n        const dataChannel = this.peerClient.createDataChannel('liquid');\n        const localSdp = await this.peerClient.createOffer();\n        await this.peerClient.setLocalDescription(localSdp);\n        this.socket.emit(`${this.type}-description`, localSdp.sdp);\n        this.emit(`${this.type}-description`, localSdp.sdp);\n        const sdp = await this.signal(type);\n        await this.peerClient.setRemoteDescription(sdp);\n        if (candidatesBuffer.length > 0) {\n          await Promise.all(\n            candidatesBuffer.map(async (candidate) => {\n              this.emit(`${type}-candidate`, candidate);\n              await this.peerClient?.addIceCandidate(\n                new RTCIceCandidate(candidate),\n              );\n            }),\n          );\n          candidatesBuffer = [];\n        }\n        this.emit('data-channel', dataChannel);\n        resolve(dataChannel);\n      }\n    });\n  }\n\n  /**\n   * Await for a link message for a given requestId\n   * @param requestId\n   */\n  async link(requestId: string) {\n    if (typeof this.requestId !== 'undefined')\n      throw new Error(REQUEST_IN_PROCESS_MESSAGE);\n    this.requestId = requestId;\n    this.emit('link', { requestId });\n\n    return new Promise<LinkMessage>((resolve) => {\n      this.socket.emit(\n        'link',\n        { requestId },\n        ({ data }: { data: LinkMessage }) => {\n          this.authenticated = true;\n          delete this.requestId;\n\n          this.emit('link-message', data);\n          resolve(data);\n        },\n      );\n    });\n  }\n\n  /**\n   *\n   * @param type\n   */\n  async signal(type: 'offer' | 'answer') {\n    if (!this.authenticated) throw new Error(UNAUTHENTICATED_MESSAGE);\n    this.emit('signal', { type });\n    return new Promise<RTCSessionDescriptionInit>((resolve) => {\n      this.socket.once(`${type}-description`, (sdp: string) => {\n        const description = { type, sdp } as RTCSessionDescriptionInit;\n        this.emit(`${type}-description`, description);\n        resolve(description);\n      });\n    });\n  }\n\n  close(disconnect = false) {\n    this.socket.removeAllListeners();\n    delete this.requestId;\n    this.authenticated = false;\n    if (disconnect) this.socket.disconnect();\n    this.emit('close');\n  }\n}\n"],"names":["uuidv7"],"mappings":"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"}