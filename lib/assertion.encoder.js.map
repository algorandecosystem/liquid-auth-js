{"version":3,"file":"assertion.encoder.js","sources":["../src/assertion.encoder.ts"],"sourcesContent":["import { CREDENTIAL_ACTION_FAILURE, INVALID_INPUT_MESSAGE } from './errors.js';\nimport { fromBase64Url, toBase64URL } from './encoding.js';\n\n/**\n * Represents an encoded authenticator assertion response typically used in WebAuthn authentication.\n * This type defines the structure of the response and ensures all required fields are provided in string format.\n *\n * EncodedAuthenticatorAssertionResponse includes:\n * - A map of additional string properties if needed.\n * - Fields such as `clientDataJSON`, `authenticatorData`, `signature`, and `userHandle`.\n *\n * The primary purpose of this type is to encapsulate the components originating from the authenticator\n * required to validate the authentication assertion.\n *\n * @protected\n */\nexport type EncodedAuthenticatorAssertionResponse = {\n  [k: string]: string;\n  clientDataJSON: string;\n  authenticatorData: string;\n  signature: string;\n  userHandle: string;\n};\n\n/**\n *\n * @param response\n * @protected\n */\nexport function encodeResponse(\n  response: AuthenticatorAssertionResponse & Record<string, ArrayBuffer>,\n) {\n  return Object.keys(\n    AuthenticatorAssertionResponse.prototype,\n  ).reduce<EncodedAuthenticatorAssertionResponse>(\n    (prev, curr) => {\n      prev[curr] = toBase64URL(response[curr]);\n      return prev;\n    },\n    {\n      clientDataJSON: toBase64URL(response.clientDataJSON),\n    } as EncodedAuthenticatorAssertionResponse,\n  );\n}\n/**\n * EncodedPublicKeyCredentialDescriptor represents a type that extends the PublicKeyCredentialDescriptor interface\n * with an additional requirement for the 'id' property to be of type string.\n *\n * This type is used to encapsulate the properties of a public key credential, including its unique identifier,\n * in a form where the 'id' is explicitly defined as a string rather than an ArrayBuffer.\n *\n * It is typically utilized in contexts where serialized or encoded values of public key credentials are required.\n *\n * Properties:\n * - id: A string representation of the unique identifier for the public key credential.\n *\n * This type is a combination of PublicKeyCredentialDescriptor properties and overrides for specific use cases\n * requiring encoded identifiers.\n * @protected\n */\nexport type EncodedPublicKeyCredentialDescriptor =\n  PublicKeyCredentialDescriptor & {\n    id: string;\n  };\n/**\n * EncodedPublicKeyCredentialRequestOptions is a composite type that extends\n * the PublicKeyCredentialRequestOptions interface. This type is designed\n * to represent request options for a WebAuthn authentication process,\n * with specific adjustments to handle encoded data formats.\n *\n * The primary purpose of this type is to ensure compatibility with encoded\n * challenges and allow credentials that are represented in an encoded format.\n *\n * Properties:\n * - Includes all properties from PublicKeyCredentialRequestOptions.\n * - `allowCredentials` (optional): An array of encoded credential descriptors\n *   that specify which credentials may be used for the assertion.\n * - `challenge`: A cryptographic random challenge provided in encoded format,\n *   used in the WebAuthn assertion process.\n *\n * This type is intended to support workflows where cryptographic data must\n * be encoded for transport or storage.\n *\n * @protected\n */\nexport type EncodedPublicKeyCredentialRequestOptions =\n  PublicKeyCredentialRequestOptions & {\n    allowCredentials?: EncodedPublicKeyCredentialDescriptor[];\n    challenge: string;\n  };\n/**\n * Decodes the given assertion request options by converting base64URL-encoded fields\n * into their corresponding ArrayBuffer representations and returns the decoded options.\n *\n * @param {EncodedPublicKeyCredentialRequestOptions} options - The encoded credential options to decode, containing properties such as `challenge` and `allowCredentials`.\n * @return {PublicKeyCredentialRequestOptions} The decoded credential request options with binary data fields properly converted.\n */\nexport function decodeOptions(\n  options: EncodedPublicKeyCredentialRequestOptions,\n): PublicKeyCredentialRequestOptions {\n  if (typeof options !== 'object' || typeof options.challenge !== 'string')\n    throw new TypeError(INVALID_INPUT_MESSAGE);\n  const decodedOptions: PublicKeyCredentialRequestOptions = { ...options };\n  decodedOptions.challenge = fromBase64Url(options.challenge as string).buffer as ArrayBuffer;\n  decodedOptions.allowCredentials =\n    options.allowCredentials?.map(\n      (cred: EncodedPublicKeyCredentialDescriptor) => {\n        return {\n          ...cred,\n          id: fromBase64Url(cred.id as string).buffer as ArrayBuffer,\n        } as PublicKeyCredentialDescriptor;\n      },\n    ) || [];\n  return decodedOptions;\n}\n\n/**\n * @protected\n */\nexport type EncodedCredential = {\n  [k: string]: string | EncodedAuthenticatorAssertionResponse;\n  id: string;\n  type: string;\n  response: EncodedAuthenticatorAssertionResponse;\n  rawId: string;\n};\n\n/**\n * Encodes the provided PublicKeyCredential into an EncodedCredential object.\n *\n * @param {PublicKeyCredential} credential - The PublicKeyCredential to be encoded.\n * @return {EncodedCredential} A new object containing the encoded properties of the credential.\n * @throws {Error} Throws an error if the input credential is invalid or cannot be processed.\n */\nexport function encodeCredential(\n  credential: Credential | null,\n): EncodedCredential {\n  if (!credential) throw new Error(INVALID_INPUT_MESSAGE);\n  const response = (credential as PublicKeyCredential)\n    .response as AuthenticatorAssertionResponse & Record<string, ArrayBuffer>;\n  if (!response) throw new Error(CREDENTIAL_ACTION_FAILURE);\n  return {\n    id: credential.id,\n    type: credential.type,\n    rawId: toBase64URL((credential as PublicKeyCredential).rawId),\n    response: encodeResponse(response),\n  };\n}\n"],"names":[],"mappings":";;AA6BO,SAAS,eACd,UACA;AACA,SAAO,OAAO;AAAA,IACZ,+BAA+B;AAAA,EAAA,EAC/B;AAAA,IACA,CAAC,MAAM,SAAS;AACd,WAAK,IAAI,IAAI,YAAY,SAAS,IAAI,CAAC;AACvC,aAAO;AAAA,IACT;AAAA,IACA;AAAA,MACE,gBAAgB,YAAY,SAAS,cAAc;AAAA,IAAA;AAAA,EACrD;AAEJ;AAsDO,SAAS,cACd,SACmC;;AACnC,MAAI,OAAO,YAAY,YAAY,OAAO,QAAQ,cAAc;AAC9D,UAAM,IAAI,UAAU,qBAAqB;AAC3C,QAAM,iBAAoD,EAAE,GAAG,QAAA;AAC/D,iBAAe,YAAY,cAAc,QAAQ,SAAmB,EAAE;AACtE,iBAAe,qBACb,aAAQ,qBAAR,mBAA0B;AAAA,IACxB,CAAC,SAA+C;AAC9C,aAAO;AAAA,QACL,GAAG;AAAA,QACH,IAAI,cAAc,KAAK,EAAY,EAAE;AAAA,MAAA;AAAA,IAEzC;AAAA,QACG,CAAA;AACP,SAAO;AACT;AAoBO,SAAS,iBACd,YACmB;AACnB,MAAI,CAAC,WAAY,OAAM,IAAI,MAAM,qBAAqB;AACtD,QAAM,WAAY,WACf;AACH,MAAI,CAAC,SAAU,OAAM,IAAI,MAAM,yBAAyB;AACxD,SAAO;AAAA,IACL,IAAI,WAAW;AAAA,IACf,MAAM,WAAW;AAAA,IACjB,OAAO,YAAa,WAAmC,KAAK;AAAA,IAC5D,UAAU,eAAe,QAAQ;AAAA,EAAA;AAErC;"}