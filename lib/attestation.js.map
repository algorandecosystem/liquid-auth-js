{"version":3,"file":"attestation.js","sources":["../src/attestation.ts"],"sourcesContent":["/**\n * This module is only for the browser and currently not used in the project.\n * However, it could be useful for extension wallets or other browser-based wallets.\n *\n * @packageDocumentation\n * @document ./attestation.guide.md\n */\nimport { fromBase64Url } from './encoding.js';\nimport {\n  AUTHENTICATOR_NOT_SUPPORTED_MESSAGE,\n  INVALID_INPUT_MESSAGE,\n} from './errors.js';\nimport {\n  DEFAULT_ATTESTATION_OPTIONS,\n  postOptions,\n  postResponse,\n} from './attestation.fetch.js';\nimport { decodeOptions, encodeCredential } from './attestation.encoder.js';\n\nexport * as fetch from './attestation.fetch.js';\nexport * as encoder from './attestation.encoder.js';\n\ntype AttestationOptions = {\n  origin: string;\n  onChallenge: (options: any) => any;\n  options?: any;\n  debug?: boolean;\n};\n\n/**\n * Performs an attestation process that involves fetching options,\n * handling a challenge, and creating a credential using the Web Authentication API.\n *\n * @param {Object} params - The configuration options for the attestation process.\n * @param {string} params.origin - The origin URL to which requests are made.\n * @param {Function} params.onChallenge - A function to handle the challenge returned by the service.\n * @param {Object} [params.options=DEFAULT_ATTESTATION_OPTIONS] - Options to customize the attestation process.\n * @param {boolean} [params.debug=false] - Flag to enable or disable debug logging.\n * @return {Promise<any>} The response from the server after completing the attestation process.\n */\nexport async function attestation(params: AttestationOptions) {\n  if (typeof navigator === 'undefined')\n    throw new Error(AUTHENTICATOR_NOT_SUPPORTED_MESSAGE);\n  if (typeof params === 'undefined') throw new Error(INVALID_INPUT_MESSAGE);\n  const {\n    origin,\n    onChallenge,\n    options = DEFAULT_ATTESTATION_OPTIONS,\n    debug,\n  } = params;\n  if (typeof origin !== 'string') {\n    throw new TypeError(INVALID_INPUT_MESSAGE);\n  }\n  debug &&\n    console.log(\n      `%cFETCHING: %c/attestation/request/`,\n      'color: yellow',\n      'color: cyan',\n    );\n\n  // Fetch the options from the service\n  const credentialOptions = await postOptions(origin, options);\n\n  debug &&\n    console.log(\n      '%cHANDLE_SIGNATURE:%c onChallenge',\n      'color: yellow',\n      'color: cyan',\n      '*'.repeat(credentialOptions.challenge.length),\n    );\n\n  // Handle the additional signature challenge\n  const liquidOptions = await onChallenge(\n    fromBase64Url(credentialOptions.challenge),\n  );\n\n  debug &&\n    console.log(\n      '%cDECODE:%c assertion.encoder.decodeOptions',\n      'color: yellow',\n      'color: cyan',\n      '*'.repeat(liquidOptions.signature.length),\n    );\n\n  // Decode the options and merge the extension\n  const mergedOptions = decodeOptions(credentialOptions, liquidOptions);\n\n  // Create the credential using the Credential API\n  const credential = await navigator.credentials\n    .create({\n      publicKey: mergedOptions,\n    })\n    // Encode the credential for submitting to the service\n    .then(encodeCredential);\n\n  // Attach the extension results\n  // TODO: this should be provided by the CredentialProvider Service\n  credential.clientExtensionResults = { liquid: liquidOptions } as any;\n\n  debug &&\n    console.log(\n      '%cPOSTING: %c/attestation/response',\n      'color: yellow',\n      'color: cyan',\n      credential,\n    );\n\n  // Send the credential to the service\n  return await postResponse(origin, credential);\n}\n"],"names":[],"mappings":";;;;;;AAwCA,eAAsB,YAAY,QAA4B;AAC5D,MAAI,OAAO,cAAc;AACvB,UAAM,IAAI,MAAM,mCAAmC;AACrD,MAAI,OAAO,WAAW,YAAa,OAAM,IAAI,MAAM,qBAAqB;AACxE,QAAM;AAAA,IACJ;AAAA,IACA;AAAA,IACA,UAAU;AAAA,IACV;AAAA,EAAA,IACE;AACJ,MAAI,OAAO,WAAW,UAAU;AAC9B,UAAM,IAAI,UAAU,qBAAqB;AAAA,EAC3C;AACA,WACE,QAAQ;AAAA,IACN;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAIJ,QAAM,oBAAoB,MAAM,YAAY,QAAQ,OAAO;AAE3D,WACE,QAAQ;AAAA,IACN;AAAA,IACA;AAAA,IACA;AAAA,IACA,IAAI,OAAO,kBAAkB,UAAU,MAAM;AAAA,EAAA;AAIjD,QAAM,gBAAgB,MAAM;AAAA,IAC1B,cAAc,kBAAkB,SAAS;AAAA,EAAA;AAG3C,WACE,QAAQ;AAAA,IACN;AAAA,IACA;AAAA,IACA;AAAA,IACA,IAAI,OAAO,cAAc,UAAU,MAAM;AAAA,EAAA;AAI7C,QAAM,gBAAgB,cAAc,mBAAmB,aAAa;AAGpE,QAAM,aAAa,MAAM,UAAU,YAChC,OAAO;AAAA,IACN,WAAW;AAAA,EAAA,CACZ,EAEA,KAAK,gBAAgB;AAIxB,aAAW,yBAAyB,EAAE,QAAQ,cAAA;AAE9C,WACE,QAAQ;AAAA,IACN;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAIJ,SAAO,MAAM,aAAa,QAAQ,UAAU;AAC9C;"}